<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish YouTube Word Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>Spanish YouTube Word Analyzer</h1>
        <nav>
            <a href="{{ url_for('index') }}" class="active">Analyze Video</a>
            <a href="{{ url_for('words_list') }}">My Words</a>
        </nav>
    </header>

    <main>
        <div class="container">
            <!-- YouTube URL Analyzer -->
            <div class="analyzer-section">
                <h2>Analyze a YouTube Video</h2>
                <div class="input-container">
                    <input type="text" id="youtube-url" placeholder="Enter YouTube video URL">
                    <button id="analyze-button">Analyze Video</button>
                </div>
            </div>

            <div class="divider">OR</div>

            <!-- File Analyzer -->
            <div class="analyzer-section">
                <h2>Analyze a Document</h2>
                <div class="input-container">
                    <input type="file" id="file-input" accept=".txt,.pdf,.docx">
                    <button id="analyze-file-button">Analyze File</button>
                </div>
            </div>

            <!-- Shared Options and Results -->
            <div class="options-container">
                <label for="filter-stop-words">
                    <input type="checkbox" id="filter-stop-words">
                    Filter common words (e.g., "el", "de", "y")
                </label>
            </div>
            
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Extracting transcript and analyzing words...</p>
            </div>
            
            <div id="word-grid" class="word-grid"></div>

            <div id="error-message" class="error-message"></div>
            
            <div id="results" class="results" style="display: none;">
                <h2>Word Frequency Analysis</h2>
                <p id="summary"></p>
                <div id="word-list"></div>
            </div>
        </div>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const analyzeButton = document.getElementById('analyze-button');
            const analyzeFileButton = document.getElementById('analyze-file-button');
            
            analyzeButton.addEventListener('click', analyzeVideo);
            analyzeFileButton.addEventListener('click', analyzeFile);
        });

        async function analyzeVideo() {
            const youtubeUrl = document.getElementById('youtube-url').value;
            if (!youtubeUrl) {
                displayError({ message: "Please enter a YouTube URL." });
                return;
            }
            
            const payload = {
                url: youtubeUrl,
                filterStopWords: document.getElementById('filter-stop-words').checked
            };
            
            fetchAndDisplay('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        async function analyzeFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            if (!file) {
                displayError({ message: "Please select a file to analyze." });
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('filterStopWords', document.getElementById('filter-stop-words').checked);

            fetchAndDisplay('/upload', {
                method: 'POST',
                body: formData
            });
        }

        async function fetchAndDisplay(endpoint, options) {
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.getElementById('error-message');

            loadingDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
            errorDiv.innerHTML = '';

            try {
                const response = await fetch(endpoint, options);
                const data = await response.json();

                if (data.error) {
                    displayError(data);
                } else {
                    displayResults(data);
                }
            } catch (err) {
                displayError({ message: "A network error occurred.", details: err.message });
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const wordGrid = document.getElementById('word-grid');
            const stats = document.getElementById('stats');

            wordGrid.innerHTML = '';
            data.words.forEach(([word, count]) => {
                const wordItem = document.createElement('div');
                wordItem.className = 'word-item';
                wordItem.innerHTML = `<span class="word">${word}</span><span class="count">${count}</span>`;
                wordGrid.appendChild(wordItem);
            });

            let sourceInfo = data.video_id 
                ? `Language: ${data.language_used}`
                : `Source File: ${data.source_filename}`;

            stats.innerHTML = `
                <strong>Total Unique Words:</strong> ${data.total_unique_words} <br>
                ${sourceInfo}
            `;
            resultsDiv.classList.remove('hidden');
        }

        function displayError(data) {
            const errorDiv = document.getElementById('error-message');
            let errorMessage = `<strong>Error:</strong> ${data.message || data.error}`;
            if (data.details) {
                errorMessage += `<br><small>Technical details: ${data.details}</small>`;
            }
            if (data.available_languages) {
                const languages = data.available_languages.map(lang => `${lang.language} (${lang.language_code})`).join(', ');
                errorMessage += `<br><small>Available languages for this video: ${languages}</small>`;
            }
            errorDiv.innerHTML = errorMessage;
        }
    </script>
</body>
</html>